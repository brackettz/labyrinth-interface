asyncapi: 2.6.0
info:
  title: "The Amazing Labyrinth - Game Interaction API"
  version: "1.4.0"
  description: |
    Specification for real-time communication for 'The Amazing Labyrinth'.
    Uses a single WebSocket connection for all game events.
    All messages (sent or received) use the 'type' field as a discriminator.

servers:
  production:
    url: "{uri}/game"
    protocol: websocket
    variables:
      uri:
        default: "ws://localhost:9000"

channels:
  /game:
    publish:
      operationId: sendClientCommand
      summary: "Client -> Server (Commands)"
      message:
        oneOf:
          - $ref: "#/components/messages/connectCommand"
          - $ref: "#/components/messages/startGameCommand"
          - $ref: "#/components/messages/pushTileCommand"
          - $ref: "#/components/messages/movePawnCommand"
          - $ref: "#/components/messages/toggleAICommand"
          - $ref: "#/components/messages/useBeamCommand"
          - $ref: "#/components/messages/useSwapCommand"
          - $ref: "#/components/messages/usePushFixedCommand"
          - $ref: "#/components/messages/usePushTwiceCommand"
    subscribe:
      operationId: receiveServerEvent
      summary: "Server -> Client (Events)"
      message:
        oneOf:
          - $ref: "#/components/messages/lobbyStateEvent"
          - $ref: "#/components/messages/gameStartedEvent"
          - $ref: "#/components/messages/gameStateUpdateEvent"
          - $ref: "#/components/messages/playerTurnEvent"
          - $ref: "#/components/messages/actionErrorEvent"
          - $ref: "#/components/messages/playerDisconnectedEvent"
          - $ref: "#/components/messages/achievementUnlockedEvent"
          - $ref: "#/components/messages/gameOverEvent"
          - $ref: "#/components/messages/nextTreasureCardEvent"

components:
  messages:
    # --- Client -> Server Messages (Commands) ---
    connectCommand:
      messageId: connectCommand
      summary: "Join the game lobby."
      payload:
        $ref: "#/components/schemas/ConnectCommandPayload"
    startGameCommand:
      messageId: startGameCommand
      summary: "Admin only: Start the game with specific settings."
      payload:
        $ref: "#/components/schemas/StartGameCommandPayload"
    pushTileCommand:
      messageId: pushTileCommand
      summary: "Push the extra tile into the board. Includes implied rotation."
      payload:
        $ref: "#/components/schemas/PushTileCommandPayload"
    movePawnCommand:
      messageId: movePawnCommand
      summary: "Move the pawn after pushing."
      payload:
        $ref: "#/components/schemas/MovePawnCommandPayload"
    toggleAICommand:
      messageId: toggleAICommand
      summary: "Enable/disable AI bot for this player."
      payload:
        $ref: "#/components/schemas/ToggleAICommandPayload"
    useBeamCommand:
      messageId: useBeamCommand
      summary: "Bonus: Teleport to target."
      payload:
        $ref: "#/components/schemas/UseBeamCommandPayload"
    useSwapCommand:
      messageId: useSwapCommand
      summary: "Bonus: Swap position with another player."
      payload:
        $ref: "#/components/schemas/UseSwapCommandPayload"
    usePushFixedCommand:
      messageId: usePushFixedCommand
      summary: "Bonus: Move a normally fixed tile."
      payload:
        $ref: "#/components/schemas/UsePushFixedCommandPayload"
    usePushTwiceCommand:
      messageId: usePushTwiceCommand
      summary: "Bonus: Push a second time this turn."
      payload:
        $ref: "#/components/schemas/UsePushTwiceCommandPayload"

    # --- Server -> Client Messages (Events) ---
    lobbyStateEvent:
      messageId: lobbyStateEvent
      summary: "Broadcast: Lobby player list changed."
      payload:
        $ref: "#/components/schemas/LobbyStateEventPayload"
    gameStartedEvent:
      messageId: gameStartedEvent
      summary: "Broadcast: The game has officially started."
      payload:
        $ref: "#/components/schemas/GameStartedEventPayload"
    gameStateUpdateEvent:
      messageId: gameStateUpdateEvent
      summary: "Broadcast: Full board and player state update."
      payload:
        $ref: "#/components/schemas/GameStateUpdateEventPayload"
    playerTurnEvent:
      messageId: playerTurnEvent
      summary: "Broadcast: Notifies all players whose turn it is."
      payload:
        $ref: "#/components/schemas/PlayerTurnEventPayload"
    actionErrorEvent:
      messageId: actionErrorEvent
      summary: "Unicast: The last command failed."
      payload:
        $ref: "#/components/schemas/ActionErrorEventPayload"
    playerDisconnectedEvent:
      messageId: playerDisconnectedEvent
      summary: "Broadcast: A player lost connection."
      payload:
        $ref: "#/components/schemas/PlayerDisconnectedEventPayload"
    achievementUnlockedEvent:
      messageId: achievementUnlockedEvent
      summary: "Broadcast: Player unlocked an achievement."
      payload:
        $ref: "#/components/schemas/AchievementUnlockedEventPayload"
    gameOverEvent:
      messageId: gameOverEvent
      summary: "Broadcast: Game ended, final stats."
      payload:
        $ref: "#/components/schemas/GameOverEventPayload"
    nextTreasureCardEvent:
      messageId: nextTreasureCardEvent
      summary: "Unicast: Informs a player of their next target."
      payload:
        $ref: "#/components/schemas/NextTreasureCardEventPayload"

  schemas:
    CommandType:
      type: string
      enum:
        - CONNECT
        - START_GAME
        - PUSH_TILE
        - MOVE_PAWN
        - TOGGLE_AI
        - USE_BEAM
        - USE_SWAP
        - USE_PUSH_FIXED
        - USE_PUSH_TWICE

    EventType:
      type: string
      enum:
        - LOBBY_STATE
        - GAME_STARTED
        - GAME_STATE_UPDATE
        - PLAYER_TURN
        - ACTION_ERROR
        - PLAYER_DISCONNECTED
        - ACHIEVEMENT_UNLOCKED
        - GAME_OVER
        - NEXT_TREASURE

    Direction:
      type: string
      enum: [UP, DOWN, LEFT, RIGHT]

    PlayerColor:
      type: string
      enum: [RED, BLUE, GREEN, YELLOW]

    TurnState:
      type: string
      enum: [WAITING_FOR_PUSH, WAITING_FOR_MOVE, WAITING_FOR_BONUS]

    ErrorCode:
       type: string
       enum: [INVALID_MOVE, NOT_YOUR_TURN, INVALID_PUSH, BONUS_NOT_AVAILABLE]

    BonusType:
       type: string
       enum: [BEAM, PUSH_FIXED, SWAP, PUSH_TWICE]

    AchievementType:
       type: string
       enum: [RUNNER, PUSHER, BLOCKER, TIME_WASTER, HATTRICK]


    ConnectCommandPayload:
      type: object
      required: [type, username]
      properties:
        type: { $ref: "#/components/schemas/CommandType" }
        username: { type: string, minLength: 1, maxLength: 20 }

    StartGameCommandPayload:
      type: object
      required: [type, boardSize, treasureCardCount]
      properties:
        type: { $ref: "#/components/schemas/CommandType" }
        boardSize:
          type: object
          required: [rows, cols]
          properties:
            rows: { type: integer, minimum: 3, default: 7 }
            cols: { type: integer, minimum: 3, default: 7 }
        treasureCardCount: { type: integer, default: 24 }
        totalBonusCount: { type: integer, default: 0 }
        gameDurationInSeconds: { type: integer }

    PushTileCommandPayload:
      type: object
      required: [type, rowOrColIndex, direction, tileEntrances]
      properties:
        type: { $ref: "#/components/schemas/CommandType" }
        rowOrColIndex: { type: integer }
        direction: { $ref: "#/components/schemas/Direction" }
        tileEntrances:
          type: array
          minItems: 1
          items: { $ref: "#/components/schemas/Direction" }

    MovePawnCommandPayload:
      type: object
      required: [type, targetCoordinates]
      properties:
        type: { $ref: "#/components/schemas/CommandType" }
        targetCoordinates: { $ref: "#/components/schemas/Coordinates" }

    ToggleAICommandPayload:
      type: object
      required: [type, enabled]
      properties:
        type: { $ref: "#/components/schemas/CommandType" }
        enabled: { type: boolean }

    UseBeamCommandPayload:
      type: object
      required: [type, targetCoordinates]
      properties:
        type: { $ref: "#/components/schemas/CommandType" }
        targetCoordinates: { $ref: "#/components/schemas/Coordinates" }

    UseSwapCommandPayload:
      type: object
      required: [type, targetPlayerId]
      properties:
        type: { $ref: "#/components/schemas/CommandType" }
        targetPlayerId: { type: string }

    UsePushFixedCommandPayload:
      type: object
      required: [type, rowOrColIndex, direction, tileEntrances]
      properties:
        type: { $ref: "#/components/schemas/CommandType" }
        rowOrColIndex: { type: integer }
        direction: { $ref: "#/components/schemas/Direction" }
        tileEntrances:
          type: array
          items: { $ref: "#/components/schemas/Direction" }

    UsePushTwiceCommandPayload:
      type: object
      required: [type]
      properties:
        type: { $ref: "#/components/schemas/CommandType" }

    # ===========================
    # === Event Payloads      ===
    # ===========================
    LobbyStateEventPayload:
      type: object
      required: [type, players]
      properties:
        type: { $ref: "#/components/schemas/EventType" }
        players:
          type: array
          items: { $ref: "#/components/schemas/PlayerInfo" }

    GameStartedEventPayload:
      type: object
      required: [type, initialBoard, players]
      properties:
        type: { $ref: "#/components/schemas/EventType" }
        initialBoard: { $ref: "#/components/schemas/GameBoard" }
        players:
           type: array
           items: { $ref: "#/components/schemas/PlayerState" }

    GameStateUpdateEventPayload:
      type: object
      required: [type, board, players, currentPlayerId, currentTurnState]
      properties:
        type: { $ref: "#/components/schemas/EventType" }
        board: { $ref: "#/components/schemas/GameBoard" }
        players:
          type: array
          items: { $ref: "#/components/schemas/PlayerState" }
        currentPlayerId: { type: string }
        currentTurnState: { $ref: "#/components/schemas/TurnState" }

    PlayerTurnEventPayload:
      type: object
      required: [type, playerId, extraTile]
      properties:
        type: { $ref: "#/components/schemas/EventType" }
        playerId: { type: string }
        extraTile: { $ref: "#/components/schemas/Tile" }
        turnTimeLimitSeconds: { type: integer }

    ActionErrorEventPayload:
      type: object
      required: [type, errorCode, message]
      properties:
        type: { $ref: "#/components/schemas/EventType" }
        errorCode: { $ref: "#/components/schemas/ErrorCode" }
        message: { type: string }

    PlayerDisconnectedEventPayload:
      type: object
      required: [type, playerId]
      properties:
        type: { $ref: "#/components/schemas/EventType" }
        playerId: { type: string }

    AchievementUnlockedEventPayload:
      type: object
      required: [type, playerId, achievement]
      properties:
        type: { $ref: "#/components/schemas/EventType" }
        playerId: { type: string }
        achievement: { $ref: "#/components/schemas/AchievementType" }

    GameOverEventPayload:
      type: object
      required: [type, ranking]
      properties:
        type: { $ref: "#/components/schemas/EventType" }
        winnerId: { type: string }
        ranking:
          type: array
          items: { $ref: "#/components/schemas/RankingEntry" }

    NextTreasureCardEventPayload:
      type: object
      required: [type, treasure]
      properties:
        type: { $ref: "#/components/schemas/EventType" }
        treasure: { $ref: "#/components/schemas/Treasure" }

    # ===========================
    # === Shared Objects      ===
    # ===========================
    PlayerInfo:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        color: { $ref: "#/components/schemas/PlayerColor" }
        isAdmin: { type: boolean }

    PlayerState:
      allOf:
        - $ref: "#/components/schemas/PlayerInfo"
        - type: object
          properties:
            currentPosition: { $ref: "#/components/schemas/Coordinates" }
            homePosition: { $ref: "#/components/schemas/Coordinates" }
            treasuresFound:
              type: array
              items: { $ref: "#/components/schemas/Treasure" }
            currentTreasure: { $ref: "#/components/schemas/Treasure" }
            remainingTreasureCount: { type: integer }
            achievements:
              type: array
              items: { $ref: "#/components/schemas/AchievementType" }
            availableBonuses:
               type: array
               items: { $ref: "#/components/schemas/BonusType" }

    Coordinates:
      type: object
      required: [x, y]
      properties:
        x: { type: integer }
        y: { type: integer }

    Tile:
      type: object
      properties:
        entrances:
          type: array
          items: { $ref: "#/components/schemas/Direction" }
        treasure: { $ref: "#/components/schemas/Treasure" }
        bonus: { $ref: "#/components/schemas/Bonus" }
        isFixed: { type: boolean, default: false }

    GameBoard:
      type: object
      properties:
        rows: { type: integer }
        cols: { type: integer }
        tiles:
          type: array
          items:
             type: array
             items: { $ref: "#/components/schemas/Tile" }
        lastPush:
           type: object
           properties:
             rowOrColIndex: { type: integer }
             direction: { $ref: "#/components/schemas/Direction" }

    Treasure:
      type: object
      required: [id, name]
      properties:
        id: { type: integer }
        name: { type: string }

    Bonus:
       type: object
       properties:
         id: { type: integer }
         type: { $ref: "#/components/schemas/BonusType" }

    RankingEntry:
      type: object
      properties:
        playerId: { type: string }
        rank: { type: integer }
        score: { type: integer }
        stats:
          type: object
          properties:
            stepsTaken: { type: integer }
            tilesPushed: { type: integer }
            treasuresCollected: { type: integer }