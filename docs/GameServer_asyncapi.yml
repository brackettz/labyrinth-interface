asyncapi: 2.6.0
info:
  title: "The Amazing Labyrinth - Game Interaction API"
  version: "1.3.0"
  description: |
    Specification for real-time communication for 'The Amazing Labyrinth'.
    Uses a single WebSocket connection for all game events.
    All messages (sent or received) use the 'type' field as a discriminator.

servers:
  production:
    url: "{uri}/game"
    protocol: websocket
    variables:
      uri:
        default: "ws://localhost:9000"

channels:
  /game:
    publish:
      operationId: sendClientCommand
      summary: "Client -> Server (Commands)"
      message:
        oneOf:
          - $ref: "#/components/messages/connectRequest"
          - $ref: "#/components/messages/startGameCommand"
          - $ref: "#/components/messages/pushTileCommand"
          - $ref: "#/components/messages/movePawnCommand"
          - $ref: "#/components/messages/toggleAICommand"
          - $ref: "#/components/messages/useBeamCommand"
          - $ref: "#/components/messages/useSwapCommand"
          - $ref: "#/components/messages/usePushFixedCommand"
          - $ref: "#/components/messages/usePushTwiceCommand"
    subscribe:
      operationId: receiveServerEvent
      summary: "Server -> Client (Events)"
      message:
        oneOf:
          - $ref: "#/components/messages/lobbyStateEvent"
          - $ref: "#/components/messages/gameStartedEvent"
          - $ref: "#/components/messages/gameStateUpdateEvent"
          - $ref: "#/components/messages/playerTurnEvent"
          - $ref: "#/components/messages/actionErrorEvent"
          - $ref: "#/components/messages/playerDisconnectedEvent"
          - $ref: "#/components/messages/achievementUnlockedEvent"
          - $ref: "#/components/messages/gameOverEvent"
          - $ref: "#/components/messages/nextTreasureCardEvent"

components:
  messages:
    # --- Client -> Server Messages (Commands) ---
    connectRequest:
      messageId: connectRequest
      summary: "Join the game lobby."
      payload:
        $ref: "#/components/schemas/ConnectRequestPayload"
    startGameCommand:
      messageId: startGameCommand
      summary: "Admin only: Start the game with specific settings."
      payload:
        $ref: "#/components/schemas/StartGamePayload"
    pushTileCommand:
      messageId: pushTileCommand
      summary: "Push the extra tile into the board. Includes implied rotation."
      payload:
        $ref: "#/components/schemas/PushTilePayload"
    movePawnCommand:
      messageId: movePawnCommand
      summary: "Move the pawn after pushing."
      payload:
        $ref: "#/components/schemas/MovePawnPayload"
    toggleAICommand:
      messageId: toggleAICommand
      summary: "Enable/disable AI bot for this player."
      payload:
        $ref: "#/components/schemas/ToggleAIPayload"
    useBeamCommand:
      messageId: useBeamCommand
      summary: "Bonus: Teleport to target."
      payload:
        $ref: "#/components/schemas/UseBeamPayload"
    useSwapCommand:
      messageId: useSwapCommand
      summary: "Bonus: Swap position with another player."
      payload:
        $ref: "#/components/schemas/UseSwapPayload"
    usePushFixedCommand:
      messageId: usePushFixedCommand
      summary: "Bonus: Move a normally fixed tile."
      payload:
        $ref: "#/components/schemas/UsePushFixedPayload"
    usePushTwiceCommand:
      messageId: usePushTwiceCommand
      summary: "Bonus: Push a second time this turn."
      payload:
        $ref: "#/components/schemas/UsePushTwicePayload"

    # --- Server -> Client Messages (Events) ---
    lobbyStateEvent:
      messageId: lobbyStateEvent
      summary: "Broadcast: Lobby player list changed."
      payload:
        $ref: "#/components/schemas/LobbyStatePayload"
    gameStartedEvent:
      messageId: gameStartedEvent
      summary: "Broadcast: The game has officially started."
      payload:
        $ref: "#/components/schemas/GameStartedPayload"
    gameStateUpdateEvent:
      messageId: gameStateUpdateEvent
      summary: "Broadcast: Full board and player state update."
      payload:
        $ref: "#/components/schemas/GameStateUpdatePayload"
    playerTurnEvent:
      messageId: playerTurnEvent
      summary: "Broadcast: Notifies all players whose turn it is."
      payload:
        $ref: "#/components/schemas/PlayerTurnPayload"
    actionErrorEvent:
      messageId: actionErrorEvent
      summary: "Unicast: The last command failed."
      payload:
        $ref: "#/components/schemas/ActionErrorPayload"
    playerDisconnectedEvent:
      messageId: playerDisconnectedEvent
      summary: "Broadcast: A player lost connection."
      payload:
        $ref: "#/components/schemas/PlayerDisconnectedPayload"
    achievementUnlockedEvent:
      messageId: achievementUnlockedEvent
      summary: "Broadcast: Player unlocked an achievement."
      payload:
        $ref: "#/components/schemas/AchievementUnlockedPayload"
    gameOverEvent:
      messageId: gameOverEvent
      summary: "Broadcast: Game ended, final stats."
      payload:
        $ref: "#/components/schemas/GameOverPayload"
    nextTreasureCardEvent:
      messageId: nextTreasureCardEvent
      summary: "Unicast: Informs a player of their next target."
      payload:
        $ref: "#/components/schemas/NextTreasureCardPayload"

  schemas:
    # --- Client Payloads (Commands) ---
    ConnectRequestPayload:
      type: object
      required: [type, username]
      properties:
        type: { type: string, enum: [CONNECT] }
        username: { type: string, minLength: 1, maxLength: 20 }

    StartGamePayload:
      type: object
      required: [type, boardSize, treasureCardCount]
      properties:
        type: { type: string, enum: [START_GAME] }
        boardSize:
          type: object
          required: [rows, cols]
          properties:
            rows: { type: integer, minimum: 3, default: 7 }
            cols: { type: integer, minimum: 3, default: 7 }
        treasureCardCount: { type: integer, default: 24 }
        totalBonusCount: { type: integer, default: 0 }
        gameDurationInSeconds: { type: integer }

    PushTilePayload:
      type: object
      required: [type, rowOrColIndex, direction, tileEntrances]
      properties:
        type: { type: string, enum: [PUSH_TILE] }
        rowOrColIndex: { type: integer }
        direction: { type: string, enum: [UP, DOWN, LEFT, RIGHT] }
        tileEntrances:
          type: array
          minItems: 1
          items: { type: string, enum: [UP, RIGHT, DOWN, LEFT] }

    MovePawnPayload:
      type: object
      required: [type, targetCoordinates]
      properties:
        type: { type: string, enum: [MOVE_PAWN] }
        targetCoordinates: { $ref: "#/components/schemas/Coordinates" }

    ToggleAIPayload:
      type: object
      required: [type, enabled]
      properties:
        type: { type: string, enum: [TOGGLE_AI] }
        enabled: { type: boolean }

    UseBeamPayload:
      type: object
      required: [type, targetCoordinates]
      properties:
        type: { type: string, enum: [USE_BEAM] }
        targetCoordinates: { $ref: "#/components/schemas/Coordinates" }

    UseSwapPayload:
      type: object
      required: [type, targetPlayerId]
      properties:
        type: { type: string, enum: [USE_SWAP] }
        targetPlayerId: { type: string }

    UsePushFixedPayload:
      type: object
      required: [type, rowOrColIndex, direction, tileEntrances]
      properties:
        type: { type: string, enum: [USE_PUSH_FIXED] }
        rowOrColIndex: { type: integer }
        direction: { type: string, enum: [UP, DOWN, LEFT, RIGHT] }
        tileEntrances:
          type: array
          items: { type: string, enum: [UP, RIGHT, DOWN, LEFT] }

    UsePushTwicePayload:
      type: object
      required: [type]
      properties:
        type: { type: string, enum: [USE_PUSH_TWICE] }

    # --- Server Payloads (Events) ---
    LobbyStatePayload:
      type: object
      required: [type, players]
      properties:
        type: { type: string, enum: [LOBBY_STATE] }
        players:
          type: array
          items: { $ref: "#/components/schemas/PlayerInfo" }

    GameStartedPayload:
      type: object
      required: [type, initialBoard, players]
      properties:
        type: { type: string, enum: [GAME_STARTED] }
        initialBoard: { $ref: "#/components/schemas/GameBoard" }
        players:
           type: array
           items: { $ref: "#/components/schemas/PlayerState" }

    GameStateUpdatePayload:
      type: object
      required: [type, board, players, currentPlayerId, currentTurnState]
      properties:
        type: { type: string, enum: [GAME_STATE_UPDATE] }
        board: { $ref: "#/components/schemas/GameBoard" }
        players:
          type: array
          items: { $ref: "#/components/schemas/PlayerState" }
        currentPlayerId: { type: string }
        currentTurnState:
           type: string
           enum: [WAITING_FOR_PUSH, WAITING_FOR_MOVE, WAITING_FOR_BONUS]

    PlayerTurnPayload:
      type: object
      required: [type, playerId, extraTile]
      properties:
        type: { type: string, enum: [PLAYER_TURN] }
        playerId: { type: string }
        extraTile: { $ref: "#/components/schemas/Tile" }
        turnTimeLimitSeconds: { type: integer }

    ActionErrorPayload:
      type: object
      required: [type, errorCode, message]
      properties:
        type: { type: string, enum: [ACTION_ERROR] }
        errorCode: { type: string, enum: [INVALID_MOVE, NOT_YOUR_TURN, INVALID_PUSH, BONUS_NOT_AVAILABLE] }
        message: { type: string }

    PlayerDisconnectedPayload:
      type: object
      required: [type, playerId]
      properties:
        type: { type: string, enum: [PLAYER_DISCONNECTED] }
        playerId: { type: string }

    AchievementUnlockedPayload:
      type: object
      required: [type, playerId, achievement]
      properties:
        type: { type: string, enum: [ACHIEVEMENT_UNLOCKED] }
        playerId: { type: string }
        achievement: { $ref: "#/components/schemas/AchievementType" }

    GameOverPayload:
      type: object
      required: [type, ranking]
      properties:
        type: { type: string, enum: [GAME_OVER] }
        winnerId: { type: string }
        ranking:
          type: array
          items: { $ref: "#/components/schemas/RankingEntry" }

    NextTreasureCardPayload:
      type: object
      required: [type, treasure]
      properties:
        type: { type: string, enum: [NEXT_TREASURE] }
        treasure: { $ref: "#/components/schemas/Treasure" }

    # --- Shared Data Structures ---
    PlayerInfo:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        color: { type: string, enum: [RED, BLUE, GREEN, YELLOW] }
        isAdmin: { type: boolean }


    PlayerState:
      allOf:
        - $ref: "#/components/schemas/PlayerInfo"
        - type: object
          properties:
            currentPosition: { $ref: "#/components/schemas/Coordinates" }
            homePosition: { $ref: "#/components/schemas/Coordinates" }
            treasuresFound:
              type: array
              items: { $ref: "#/components/schemas/Treasure" }
            currentTreasure: { $ref: "#/components/schemas/Treasure" }
            remainingTreasureCount: { type: integer }
            achievements:
              type: array
              items: { $ref: "#/components/schemas/AchievementType" }
            availableBonuses:
               type: array
               items: { $ref: "#/components/schemas/BonusType" }

    Coordinates:
      type: object
      required: [x, y]
      properties:
        x: { type: integer }
        y: { type: integer }

    Tile:
      type: object
      properties:
        entrances:
          type: array
          items:
            type: string
            enum: [UP, RIGHT, DOWN, LEFT]
        treasure: { $ref: "#/components/schemas/Treasure" }
        bonus: { $ref: "#/components/schemas/Bonus" }
        isFixed: { type: boolean, default: false }

    GameBoard:
      type: object
      properties:
        rows: { type: integer }
        cols: { type: integer }
        tiles:
          type: array
          items:
             type: array
             items: { $ref: "#/components/schemas/Tile" }
        lastPush:
           type: object
           properties:
             rowOrColIndex: { type: integer }
             direction: { type: string, enum: [UP, DOWN, LEFT, RIGHT] }

    Treasure:
      type: object
      required: [id, name]
      properties:
        id: { type: integer }
        name: { type: string }

    Bonus:
       type: object
       properties:
         id: { type: integer }
         type: { $ref: "#/components/schemas/BonusType" }

    BonusType:
       type: string
       enum: [BEAM, PUSH_FIXED, SWAP, PUSH_TWICE]

    AchievementType:
       type: string
       enum: [RUNNER, PUSHER, BLOCKER, TIME_WASTER, HATTRICK]

    RankingEntry:
      type: object
      properties:
        playerId: { type: string }
        rank: { type: integer }
        score: { type: integer }
        stats:
          type: object
          properties:
            stepsTaken: { type: integer }
            tilesPushed: { type: integer }
            treasuresCollected: { type: integer }