asyncapi: 2.6.0
info:
  title: "The Amazing Labyrinth - Game Interaction API"
  version: "1.1.0"
  description: |
    This specification outlines the event-driven API for real-time communication during a game of 'The Amazing Labyrinth'. 
    All communication happens over a single WebSocket connection to the `/game` endpoint.

servers:
  production:
    url: "{uri}/game"
    protocol: websocket
    description: "The game server's WebSocket connection endpoint."
    variables:
      uri:
        default: "ws://localhost:9000"
        description: "The base URI of the game server."

channels:
  /game:
    publish:
      summary: "Client -> Server (Actions)"
      description: "Used by the client to send player actions to the server."
      message:
        oneOf:
          - $ref: "#/components/messages/connectRequest"
          - $ref: "#/components/messages/startGameAction"
          - $ref: "#/components/messages/pushTileAction"
          - $ref: "#/components/messages/movePawnAction"
          - $ref: "#/components/messages/toggleAI"
          - $ref: "#/components/messages/useBeamAction"
          - $ref: "#/components/messages/usePushFixedAction"
          - $ref: "#/components/messages/useSwapAction"
          - $ref: "#/components/messages/usePushTwiceAction"
    subscribe:
      summary: "Server -> Client (Broadcasts & Unicasts)"
      description: "Used by the server to send game events and state updates to clients (both broadcast and unicast)."
      message:
        oneOf:
          - $ref: "#/components/messages/lobbyState"
          - $ref: "#/components/messages/gameStarted"
          - $ref: "#/components/messages/gameStateUpdate"
          - $ref: "#/components/messages/playerTurn" 
          - $ref: "#/components/messages/playerDisconnected"
          - $ref: "#/components/messages/achievementUnlocked"
          - $ref: "#/components/messages/gameOver"
          - $ref: "#/components/messages/nextTreasureCard"
          - $ref: "#/components/messages/actionError"

components:
  messages:
    # Client -> Server Messages
    connectRequest:
      summary: "Action to join the game lobby."
      payload:
        $ref: "#/components/schemas/ConnectRequestPayload"
    startGameAction:
      summary: "Action to start the game with specific settings. Only the Administrator can start the game."
      payload:
        $ref: "#/components/schemas/StartGamePayload"
    pushTileAction:
      summary: "Action to push the extra tile into a row or column."
      payload:
        $ref: "#/components/schemas/PushTileActionPayload"
    movePawnAction:
      summary: "Action to move the player's pawn after pushing a tile."
      payload:
        $ref: "#/components/schemas/MovePawnActionPayload"
    toggleAI:
      summary: "Action to enable or disable the AI for the player's pawn."
      payload:
        $ref: "#/components/schemas/ToggleAIPayload"

    useBeamAction:
      summary: "Use the BEAM bonus to teleport to a specific coordinate."
      payload:
        $ref: "#/components/schemas/UseBeamActionPayload"
    useSwapAction:
      summary: "Use the SWAP bonus to exchange positions with another player."
      payload:
        $ref: "#/components/schemas/UseSwapActionPayload"
    usePushFixedAction:
      summary: "Use the PUSH_FIXED bonus to move a fixed tile."
      payload:
        $ref: "#/components/schemas/UsePushFixedActionPayload"
    usePushTwiceAction:
      summary: "Use the PUSH_TWICE bonus to allow an extra push this turn."
      payload:
        $ref: "#/components/schemas/UsePushTwiceActionPayload"

    # Server -> Client Messages
    lobbyState:
      summary: "Event broadcast when the lobby's player list changes."
      payload:
        $ref: "#/components/schemas/LobbyStatePayload"
    gameStarted:
      summary: "Event sent to each player once the game started with their treasure cards"
      payload:
        $ref: "#/components/schemas/GameStartedPayload"
    gameStateUpdate:
      summary: "Event broadcast after a player's turn, containing the updated board and player positions."
      payload:
        $ref: "#/components/schemas/GameStateUpdatePayload"
    playerTurn:
      summary: "Event indicating which player's turn it is and providing them with the extra tile."
      payload:
        $ref: "#/components/schemas/PlayerTurnPayload"
    actionError:
      summary: "Event sent to a client that attempted an invalid action."
      payload:
        $ref: "#/components/schemas/ActionErrorPayload"
    playerDisconnected:
      summary: "Event broadcast when a player disconnects or times out."
      payload:
        $ref: "#/components/schemas/PlayerDisconnectedPayload"
    achievementUnlocked:
      summary: "Event broadcast when a player unlocks an achievement."
      payload:
        $ref: "#/components/schemas/AchievementUnlockedPayload"
    gameOver:
      summary: "Event broadcast when the game has ended, containing final scores and stats."
      payload:
        $ref: "#/components/schemas/GameOverPayload"
    nextTreasureCard:
      summary: "Event unicast when the player needs a new treasure card."
      payload:
        $ref: "#/components/schemas/NextTreasureCardPayload"

  schemas:
    # Action Payloads (Client -> Server)
    ConnectRequestPayload:
      type: object
      properties:
        action:
          type: string
          enum: [CONNECT]
          description: "The type of action."
        username:
          type: string
          description: "The desired username for the player."
    StartGamePayload:
      type: object
      properties:
        action:
          type: string
          enum: [START_GAME]
        gameDurationInSeconds:
          type: integer
          description: "An object specifying the grid dimensions (number of rows and columns) of the game board."
        boardSize:
          type: object
          properties:
            rows: { type: integer }
            cols: { type: integer }
        treasureCardCount:
          type: integer
          description: "The total integer count of unique treasures available in game. This number must be evenly divisible by the number of players to ensure fair distribution."
        boniCount:
          type: integer
          description: "The total integer count of boni available on the board."

    PushTileActionPayload:
      type: object
      properties:
        action:
          type: string
          enum: [PUSH_TILE]
        rowOrColIndex:
          type: integer
          description: "The index of the row or column to push (e.g., 0, 3, 5)."
        direction:
          type: string
          enum: [UP, DOWN, LEFT, RIGHT]
          description: "The direction to push the tile from."
        tilEntrances:
          type: array
          description: "List of open directions from this tile (e.g., UP, RIGHT, DOWN, LEFT)."
          items:
            type: string
            enum: [UP, RIGHT, DOWN, LEFT]
          example: ["UP", "RIGHT"]
    MovePawnActionPayload:
      type: object
      properties:
        action:
          type: string
          enum: [MOVE_PAWN]
        targetCoordinates:
          $ref: "#/components/schemas/Coordinates"
    ToggleAIPayload:
      type: object
      properties:
        action:
          type: string
          enum: [TOGGLE_AI]
        enabled:
          type: boolean
          description: "Set to true to enable AI, false to disable."
          
    UseBeamActionPayload:
      type: object
      properties:
        action:
          type: string
          enum: [USE_BEAM]
        targetCoordinates:
          $ref: "#/components/schemas/Coordinates"
    UseSwapActionPayload:
      type: object
      properties:
        action:
          type: string
          enum: [USE_SWAP]
        targetPlayerId:
          type: string
          description: "The ID of the player to swap positions with."

    UsePushFixedActionPayload:
      type: object
      properties:
        action:
          type: string
          enum: [USE_PUSH_FIXED]
        rowOrColIndex:
          type: integer
        direction:
          type: string
          enum: [UP, DOWN, LEFT, RIGHT]
        tileEntrances:
          type: array
          items:
            type: string
            enum: [UP, RIGHT, DOWN, LEFT]

    UsePushTwiceActionPayload:
      type: object
      properties:
        action:
          type: string
          enum: [USE_PUSH_TWICE]

    # Event Payloads (Server -> Client)
    LobbyStatePayload:
      type: object
      properties:
        eventType:
          type: string
          enum: [LOBBY_STATE]
        players:
          type: array
          items: { $ref: "#/components/schemas/PlayerInfo" }
    GameStartedPayload:
      type: object
      properties:
        eventType:
          type: string
          enum: [GAME_STARTED]
    GameStateUpdatePayload:
      type: object
      properties:
        eventType:
          type: string
          enum: [GAME_STATE_UPDATE]
        board: { $ref: "#/components/schemas/GameBoard" }
        players:
          type: array
          items: { $ref: "#/components/schemas/PlayerState" }
    PlayerTurnPayload:
      type: object
      properties:
        eventType:
          type: string
          enum: [PLAYER_TURN]
        playerId:
          type: string
          description: "The ID of the player whose turn it is."
        extraTile:
          $ref: "#/components/schemas/Tile"
    ActionErrorPayload:
      type: object
      properties:
        eventType:
          type: string
          enum: [ACTION_ERROR]
        message:
          type: string
          description: "A human-readable error message explaining why the action was invalid."
    PlayerDisconnectedPayload:
      type: object
      properties:
        eventType:
          type: string
          enum: [PLAYER_DISCONNECTED]
        playerId:
          type: string
          description: "The ID of the player who disconnected."
    AchievementUnlockedPayload:
      type: object
      properties:
        eventType:
          type: string
          enum: [ACHIEVEMENT_UNLOCKED]
        playerId:
          type: string
        achievement:
          type: string
          enum: [Runner, Pusher, Blocker, TimeWaster, Hattrick]
    GameOverPayload:
      type: object
      properties:
        eventType:
          type: string
          enum: [GAME_OVER]
        ranking:
          type: array
          items: { $ref: "#/components/schemas/RankingEntry" }
    NextTreasureCardPayload:
      type: object
      properties:
        treasure: { $ref: "#/components/schemas/Treasure" }

    # Reusable Data Schemas
    PlayerInfo:
      type: object
      description: "Basic information about a player, used in the lobby."
      properties:
        id: { type: string, description: "Unique player ID." }
        name: { type: string, description: "Player's username." }
    PlayerState:
      allOf:
        - $ref: "#/components/schemas/PlayerInfo"
        - type: object
          description: "Full state of a player during a game."
          properties:
            position: { $ref: "#/components/schemas/Coordinates" }
            treasuresFound: 
              type: array
              description: "Found treasures by player"
              items: { $ref: "#/components/schemas/Treasure" }
            points:
              type: integer
            achievements:
              type: array
              items:
                type: string
                enum: [Runner, Pusher, Blocker, TimeWaster, Hattrick]
    Coordinates:
      type: object
      properties:
        x: { type: integer, description: "The column index (0-based)." }
        y: { type: integer, description: "The row index (0-based)." }
    Tile:
      type: object
      description: "Represents a single tile on the game board."
      properties:
        entrances:
          type: array
          description: "List of open directions from this tile (e.g., UP, RIGHT, DOWN, LEFT)."
          items:
            type: string
            enum: [UP, RIGHT, DOWN, LEFT]
          example: ["UP", "RIGHT"]
        treasure: 
          $ref: "#/components/schemas/Treasure"
        bonus: 
          $ref: "#/components/schemas/Bonus"
    GameBoard:
      type: object
      properties:
        size:
          type: object
          properties:
            rows: { type: integer }
            cols: { type: integer }
        tiles:
          type: array
          description: "A 2D array representing the board, with `tiles[y][x]`."
          items:
            type: array
            items: { $ref: "#/components/schemas/Tile" }
    Treasure:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
    Bonus:
      type: object
      properties:
        id: { type: string }
        type: { type: "string", enum: [BEAM, PUSH_FIXED, SWAP, PUSH_TWICE] }
    RankingEntry:
      type: object
      properties:
        playerId: { type: string }
        playerName: { type: string }
        rank: { type: integer }
        points: { type: integer }
        stats:
          type: object
          properties:
            stepsTaken: { type: integer }
            tilesPushed: { type: integer }
            treasuresCollected: { type: integer }